<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#8B4513">
    <meta name="description" content="è€ƒç ”å¤‡è€ƒç³»ç»Ÿ - çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ">
    <title>çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ - è€ƒç ”å¤‡è€ƒç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
    <!-- PWAé…ç½® -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" href="icons/icon-192x192.png">
</head>
<body>
    <header>
        <h1>ğŸ“š çŸ¥è¯†ç‚¹ç®¡ç†</h1>
        <nav class="breadcrumb">
            <a href="index.html">é¦–é¡µ</a> > çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ
        </nav>
    </header>

    <main>
        <div class="onenote-layout">
            <!-- ä¾§è¾¹æ  - ç§‘ç›®å¯¼èˆª -->
            <aside class="onenote-sidebar">
                <div class="sidebar-header">
                    <h2>ğŸ“š ç§‘ç›®å¯¼èˆª</h2>
                </div>
                <ul class="subject-nav">
                    <li class="subject-item active" data-subject="all">
                        <span class="subject-icon">ğŸ“‹</span>
                        <span class="subject-name">å…¨éƒ¨çŸ¥è¯†ç‚¹</span>
                    </li>
                    <li class="subject-item" data-subject="math">
                        <span class="subject-icon">ğŸ”¢</span>
                        <span class="subject-name">æ•°å­¦ä¸€</span>
                    </li>
                    <li class="subject-item" data-subject="english">
                        <span class="subject-icon">ğŸ”¤</span>
                        <span class="subject-name">è‹±è¯­ä¸€</span>
                    </li>
                    <li class="subject-item" data-subject="politics">
                        <span class="subject-icon">ğŸ›ï¸</span>
                        <span class="subject-name">æ”¿æ²»</span>
                    </li>
                    <li class="subject-item" data-subject="data-structure">
                        <span class="subject-icon">ğŸ“Š</span>
                        <span class="subject-name">æ•°æ®ç»“æ„</span>
                    </li>
                    <li class="subject-item" data-subject="coa">
                        <span class="subject-icon">âš™ï¸</span>
                        <span class="subject-name">è®¡ç®—æœºç»„æˆåŸç†</span>
                    </li>
                    <li class="subject-item" data-subject="os">
                        <span class="subject-icon">ğŸ’»</span>
                        <span class="subject-name">æ“ä½œç³»ç»Ÿ</span>
                    </li>
                    <li class="subject-item" data-subject="cn">
                        <span class="subject-icon">ğŸŒ</span>
                        <span class="subject-name">è®¡ç®—æœºç½‘ç»œ</span>
                    </li>
                </ul>
                
                <div class="sidebar-section">
                    <h3>ğŸ“Œ æŒæ¡çŠ¶æ€</h3>
                    <ul class="status-filters">
                        <li class="filter-item active" data-filter="all">
                            <span class="filter-color all"></span>
                            <span class="filter-name">å…¨éƒ¨çŠ¶æ€</span>
                            <span class="filter-count" id="count-all">0</span>
                        </li>
                        <li class="filter-item" data-filter="unmastered">
                            <span class="filter-color unmastered"></span>
                            <span class="filter-name">æœªæŒæ¡</span>
                            <span class="filter-count" id="count-unmastered">0</span>
                        </li>
                        <li class="filter-item" data-filter="basic">
                            <span class="filter-color basic"></span>
                            <span class="filter-name">åŸºæœ¬æŒæ¡</span>
                            <span class="filter-count" id="count-basic">0</span>
                        </li>
                        <li class="filter-item" data-filter="proficient">
                            <span class="filter-color proficient"></span>
                            <span class="filter-name">ç†Ÿç»ƒæŒæ¡</span>
                            <span class="filter-count" id="count-proficient">0</span>
                        </li>
                    </ul>
                </div>
            </aside>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="onenote-main">
                <!-- æ·»åŠ çŸ¥è¯†ç‚¹è¡¨å• -->
                <section class="card knowledge-form-card">
                    <div class="card-header">
                        <h2>â• æ·»åŠ çŸ¥è¯†ç‚¹</h2>
                    </div>
                    <div class="card-body">
                        <div class="knowledge-form">
                            <div class="form-row">
                                <select id="knowledge-subject" class="form-control">
                                    <option value="math">ğŸ”¢ æ•°å­¦ä¸€</option>
                                    <option value="english">ğŸ”¤ è‹±è¯­ä¸€</option>
                                    <option value="politics">ğŸ›ï¸ æ”¿æ²»</option>
                                    <option value="data-structure">ğŸ“Š æ•°æ®ç»“æ„</option>
                                    <option value="coa">âš™ï¸ è®¡ç®—æœºç»„æˆåŸç†</option>
                                    <option value="os">ğŸ’» æ“ä½œç³»ç»Ÿ</option>
                                    <option value="cn">ğŸŒ è®¡ç®—æœºç½‘ç»œ</option>
                                </select>
                                <input type="text" id="new-knowledge-point" class="form-control" placeholder="è¾“å…¥çŸ¥è¯†ç‚¹åç§°...">
                                <button id="add-knowledge-point" class="btn-primary">æ·»åŠ </button>
                            </div>
                            <div class="form-row">
                                <textarea id="knowledge-description" class="form-control" placeholder="çŸ¥è¯†ç‚¹è¯¦ç»†æè¿°..."></textarea>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- çŸ¥è¯†ç‚¹åˆ—è¡¨ -->
                <section class="card knowledge-list-card">
                    <div class="card-header">
                        <h2>ğŸ“– çŸ¥è¯†ç‚¹åˆ—è¡¨</h2>
                        <div class="knowledge-actions">
                            <button id="expand-all" class="btn-secondary">å±•å¼€å…¨éƒ¨</button>
                            <button id="collapse-all" class="btn-secondary">æŠ˜å å…¨éƒ¨</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="knowledge-display">
                            <ul id="knowledge-points-list" class="knowledge-list"></ul>
                        </div>
                    </div>
                </section>

                <!-- çŸ¥è¯†ç‚¹è¯¦æƒ…é¢æ¿ -->
                <section class="card knowledge-detail-card hidden">
                    <div class="card-header">
                        <h2 id="detail-title">çŸ¥è¯†ç‚¹è¯¦æƒ…</h2>
                        <div class="detail-actions">
                            <button id="edit-detail" class="btn-secondary">ç¼–è¾‘</button>
                            <button id="close-detail" class="btn-secondary">å…³é—­</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="knowledge-detail-content">
                            <div class="detail-section">
                                <h3>ğŸ“ æè¿°</h3>
                                <div id="detail-description" class="detail-content"></div>
                            </div>
                            <div class="detail-section">
                                <h3>ğŸ“Š æŒæ¡çŠ¶æ€</h3>
                                <div id="detail-status" class="detail-content">
                                    <span class="status-badge" id="status-badge"></span>
                                </div>
                            </div>
                            <div class="detail-section">
                                <h3>ğŸ“š æ‰€å±ç§‘ç›®</h3>
                                <div id="detail-subject" class="detail-content"></div>
                            </div>
                            <div class="detail-section">
                                <h3>â° åˆ›å»ºæ—¶é—´</h3>
                                <div id="detail-created" class="detail-content"></div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- å¼•å…¥æ•°æ®åº“æ¨¡å— -->
    <script src="db.js"></script>
    <script src="script.js"></script>
    <script>
        // åˆå§‹åŒ–è¯¥é¡µé¢ç‰¹å®šåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', async function() {
            await initDB();
            loadKnowledgePoints();
            setupKnowledgeEventListeners();
            
            // ç»‘å®šæ·»åŠ çŸ¥è¯†ç‚¹æŒ‰é’®äº‹ä»¶
            document.getElementById('add-knowledge-point').addEventListener('click', addKnowledgePoint);
        });
        
        // æ·»åŠ çŸ¥è¯†ç‚¹åŠŸèƒ½
        async function addKnowledgePoint() {
            const subjectSelect = document.getElementById('knowledge-subject');
            const nameInput = document.getElementById('new-knowledge-point');
            const descriptionInput = document.getElementById('knowledge-description');
            
            const subject = subjectSelect.value;
            const name = nameInput.value.trim();
            const description = descriptionInput.value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥çŸ¥è¯†ç‚¹åç§°');
                return;
            }
            
            const id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            const created = new Date().toLocaleString('zh-CN');
            const status = 'unmastered'; // é»˜è®¤çŠ¶æ€ä¸ºæœªæŒæ¡
            
            try {
                await studyDB.add('knowledgePoints', {
                    id: id,
                    subject: subject,
                    name: name,
                    description: description,
                    status: status,
                    created: created
                });
                
                // æ·»åŠ åˆ°DOM
                addKnowledgePointToDOM(subject, name, description, status, created, id);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                nameInput.value = '';
                descriptionInput.value = '';
                
                // æ›´æ–°è®¡æ•°
                updateKnowledgeCounts();
            } catch (error) {
                console.error('æ·»åŠ çŸ¥è¯†ç‚¹å¤±è´¥:', error);
                alert('æ·»åŠ çŸ¥è¯†ç‚¹å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ·»åŠ çŸ¥è¯†ç‚¹åˆ°DOM
        function addKnowledgePointToDOM(subject, name, description, status, created, id) {
            const list = document.getElementById('knowledge-points-list');
            const li = document.createElement('li');
            li.className = 'knowledge-item';
            li.dataset.subject = subject;
            li.dataset.status = status;
            li.dataset.id = id;
            
            const subjectMap = {
                'math': 'æ•°å­¦ä¸€',
                'english': 'è‹±è¯­ä¸€',
                'politics': 'æ”¿æ²»',
                'data-structure': 'æ•°æ®ç»“æ„',
                'coa': 'è®¡ç®—æœºç»„æˆåŸç†',
                'os': 'æ“ä½œç³»ç»Ÿ',
                'cn': 'è®¡ç®—æœºç½‘ç»œ'
            };
            
            const statusMap = {
                'unmastered': 'æœªæŒæ¡',
                'basic': 'åŸºæœ¬æŒæ¡',
                'proficient': 'ç†Ÿç»ƒæŒæ¡'
            };
            
            const statusClassMap = {
                'unmastered': 'status-unmastered',
                'basic': 'status-basic',
                'proficient': 'status-proficient'
            };
            
            li.innerHTML = `
                <div class="knowledge-item-header">
                    <div class="knowledge-title">${name}</div>
                    <div class="knowledge-subject">${subjectMap[subject] || subject}</div>
                    <div class="knowledge-status ${statusClassMap[status]}">${statusMap[status]}</div>
                </div>
                <div class="knowledge-item-content" style="display: none;">
                    <div class="knowledge-description">${description || 'æš‚æ— æè¿°'}</div>
                    <div class="knowledge-actions-row">
                        <button class="btn-secondary change-status" data-status="unmastered">æœªæŒæ¡</button>
                        <button class="btn-secondary change-status" data-status="basic">åŸºæœ¬æŒæ¡</button>
                        <button class="btn-secondary change-status" data-status="proficient">ç†Ÿç»ƒæŒæ¡</button>
                        <button class="btn-secondary delete-knowledge">åˆ é™¤</button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶å±•å¼€/æŠ˜å 
            const header = li.querySelector('.knowledge-item-header');
            header.addEventListener('click', function() {
                const content = li.querySelector('.knowledge-item-content');
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    li.classList.add('expanded');
                } else {
                    content.style.display = 'none';
                    li.classList.remove('expanded');
                }
            });
            
            // æ·»åŠ çŠ¶æ€å˜æ›´äº‹ä»¶
            const statusButtons = li.querySelectorAll('.change-status');
            statusButtons.forEach(button => {
                button.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const newStatus = this.dataset.status;
                    try {
                        // æ›´æ–°æ•°æ®åº“
                        const points = await studyDB.getAll('knowledgePoints');
                        const point = points.find(p => p.id === id);
                        if (point) {
                            point.status = newStatus;
                            await studyDB.update('knowledgePoints', point);
                            
                            // æ›´æ–°UI
                            const statusElement = li.querySelector('.knowledge-status');
                            const statusClassMap = {
                                'unmastered': 'status-unmastered',
                                'basic': 'status-basic',
                                'proficient': 'status-proficient'
                            };
                            
                            const statusMap = {
                                'unmastered': 'æœªæŒæ¡',
                                'basic': 'åŸºæœ¬æŒæ¡',
                                'proficient': 'ç†Ÿç»ƒæŒæ¡'
                            };
                            
                            statusElement.className = 'knowledge-status ' + statusClassMap[newStatus];
                            statusElement.textContent = statusMap[newStatus];
                            li.dataset.status = newStatus;
                            
                            // æ›´æ–°è®¡æ•°
                            updateKnowledgeCounts();
                        }
                    } catch (error) {
                        console.error('æ›´æ–°çŸ¥è¯†ç‚¹çŠ¶æ€å¤±è´¥:', error);
                    }
                });
            });
            
            // æ·»åŠ åˆ é™¤äº‹ä»¶
            const deleteButton = li.querySelector('.delete-knowledge');
            deleteButton.addEventListener('click', async function(e) {
                e.stopPropagation();
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçŸ¥è¯†ç‚¹å—ï¼Ÿ')) {
                    try {
                        await studyDB.delete('knowledgePoints', id);
                        li.remove();
                        updateKnowledgeCounts();
                    } catch (error) {
                        console.error('åˆ é™¤çŸ¥è¯†ç‚¹å¤±è´¥:', error);
                        alert('åˆ é™¤çŸ¥è¯†ç‚¹å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }
            });
            
            list.appendChild(li);
        }
        
        // åŠ è½½çŸ¥è¯†ç‚¹
        async function loadKnowledgePoints(subject = 'all') {
            try {
                const list = document.getElementById('knowledge-points-list');
                list.innerHTML = '';
                
                const points = await studyDB.getAll('knowledgePoints');
                points.forEach(point => {
                    if (subject === 'all' || point.subject === subject) {
                        addKnowledgePointToDOM(
                            point.subject, 
                            point.name, 
                            point.description, 
                            point.status, 
                            point.created, 
                            point.id
                        );
                    }
                });
                
                updateKnowledgeCounts();
            } catch (error) {
                console.error('åŠ è½½çŸ¥è¯†ç‚¹å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°çŸ¥è¯†ç‚¹è®¡æ•°
        async function updateKnowledgeCounts() {
            try {
                const points = await studyDB.getAll('knowledgePoints');
                
                const counts = {
                    'all': points.length,
                    'unmastered': points.filter(p => p.status === 'unmastered').length,
                    'basic': points.filter(p => p.status === 'basic').length,
                    'proficient': points.filter(p => p.status === 'proficient').length
                };
                
                document.getElementById('count-all').textContent = counts.all;
                document.getElementById('count-unmastered').textContent = counts.unmastered;
                document.getElementById('count-basic').textContent = counts.basic;
                document.getElementById('count-proficient').textContent = counts.proficient;
            } catch (error) {
                console.error('æ›´æ–°çŸ¥è¯†ç‚¹è®¡æ•°å¤±è´¥:', error);
            }
        }
    </script>
</body>
</html>